<div class="product-details-page" dir="rtl">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <p class="loading-text">جاري تحميل المنتج...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle error-icon"></i>
      <h2 class="error-title">حدث خطأ</h2>
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" routerLink="/shop">
        <i class="fas fa-arrow-right me-2"></i>
        العودة إلى المتجر
      </button>
    </div>
  </div>

  <!-- Product Content -->
  <div *ngIf="product && !loading && !error" class="product-content">
    <div class="container">
      <div class="row g-4">
        <!-- Product Images Section -->
        <div class="col-lg-6">
          <div class="product-images-section">
            <!-- Main Image -->
            <div class="main-image-wrapper">
              <img
                *ngIf="!hasImageError('main-' + selectedImageIndex)"
                [src]="getImageUrl(allImages[selectedImageIndex])"
                [alt]="product.title"
                class="main-image"
                (error)="onImageError('main-' + selectedImageIndex)"
                loading="eager">
              <div *ngIf="hasImageError('main-' + selectedImageIndex) || !allImages[selectedImageIndex]"
                   class="main-image-placeholder">
                <i class="fas fa-image fa-4x text-muted"></i>
                <p class="text-muted mt-3">لا توجد صورة</p>
              </div>

              <!-- Discount Badge -->
              <span *ngIf="product.priceAfterDiscount" class="discount-badge">
                -{{ getDiscountPercentage() }}%
              </span>
            </div>

            <!-- Image Gallery Thumbnails -->
            <div *ngIf="allImages.length > 1" class="image-gallery">
              <button
                *ngFor="let image of allImages; let i = index"
                class="gallery-thumbnail"
                [class.active]="i === selectedImageIndex"
                (click)="selectImage(i)"
                [attr.aria-label]="'صورة ' + (i + 1)">
                <img
                  [src]="getImageUrl(image)"
                  [alt]="product.title + ' - صورة ' + (i + 1)"
                  loading="lazy"
                  (error)="onImageError('thumb-' + i)">
              </button>
            </div>
          </div>
        </div>

        <!-- Product Info Section -->
        <div class="col-lg-6">
          <div class="product-info-section">
            <!-- Category Badge -->
            <div *ngIf="product.category" class="category-badge">
              <i class="fas fa-tag me-2"></i>
              {{ product.category.name }}
            </div>

            <!-- Product Title -->
            <h1 class="product-title">{{ product.title }}</h1>

            <!-- Product Price -->
            <div class="product-price-section">
              <span class="current-price">{{ getProductPrice() | currency:'EGP':'symbol':'1.0-0' }}</span>
              <span *ngIf="getOriginalPrice()" class="original-price">
                {{ getOriginalPrice() | currency:'EGP':'symbol':'1.0-0' }}
              </span>
            </div>

            <!-- Stock Status -->
            <div class="stock-status">
              <span [class]="'stock-badge ' + (isOutOfStock ? 'out-of-stock' : (totalStock <= 3 ? 'low-stock' : 'in-stock'))">
                <i [class]="'fas me-2 ' + (isOutOfStock ? 'fa-times-circle' : (totalStock <= 3 ? 'fa-exclamation-triangle' : 'fa-check-circle'))"></i>
                {{ getStockStatus() }}
              </span>
            </div>

            <!-- Product Description -->
            <div *ngIf="product.description" class="product-description">
              <h3 class="section-heading">الوصف</h3>
              <p class="description-text">{{ product.description }}</p>
            </div>

            <!-- Color Selection -->
            <div *ngIf="product.colors && product.colors.length > 0" class="product-options">
              <h3 class="section-heading">
                اللون
                <span class="required-indicator">*</span>
              </h3>
              <div class="color-options">
                <button
                  *ngFor="let color of product.colors"
                  class="color-option"
                  [class.selected]="selectedColor === color"
                  [attr.aria-label]="'اختر لون ' + color"
                  (click)="selectColor(color)"
                  [title]="color">
                  <span class="color-bullet" [style.background-color]="getColorValue(color)"></span>
                  <i *ngIf="selectedColor === color" class="fas fa-check check-icon"></i>
                </button>
              </div>
              <p *ngIf="!selectedColor" class="option-hint">يرجى اختيار لون</p>
            </div>

            <!-- Size Selection -->
            <div *ngIf="availableSizes.length > 0" class="product-options">
              <h3 class="section-heading">
                الحجم
                <span class="required-indicator">*</span>
              </h3>
              <div class="size-options">
                <button
                  *ngFor="let sizeData of availableSizes"
                  class="size-option"
                  [class.selected]="selectedSize === sizeData.size"
                  [class.disabled]="sizeData.no <= 0"
                  [class.low-stock-size]="sizeData.no > 0 && sizeData.no <= 3"
                  [attr.aria-label]="'اختر حجم ' + sizeData.size"
                  (click)="selectSize(sizeData.size)"
                  [disabled]="sizeData.no <= 0">
                  <span class="size-name">{{ sizeData.size.toUpperCase() }}</span>
                  <span class="size-stock-status" *ngIf="sizeData.no > 0">
                    ({{ getSizeStockStatus(sizeData) }})
                  </span>
                </button>
              </div>
              <p *ngIf="!selectedSize" class="option-hint">يرجى اختيار حجم</p>
            </div>

            <!-- Quantity Selector -->
            <div *ngIf="selectedSize && !isOutOfStock" class="quantity-selector">
              <h3 class="section-heading">الكمية</h3>
              <div class="quantity-controls">
                <button
                  class="quantity-btn"
                  (click)="decreaseQuantity()"
                  [disabled]="quantity <= 1"
                  aria-label="تقليل الكمية">
                  <i class="fas fa-minus"></i>
                </button>
                <input
                  type="number"
                  class="quantity-input"
                  [(ngModel)]="quantity"
                  [min]="1"
                  [max]="getMaxQuantity()"
                  (change)="quantity = quantity > getMaxQuantity() ? getMaxQuantity() : (quantity < 1 ? 1 : quantity)"
                  aria-label="الكمية">
                <button
                  class="quantity-btn"
                  (click)="increaseQuantity()"
                  [disabled]="quantity >= getMaxQuantity()"
                  aria-label="زيادة الكمية">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button
                class="btn btn-add-to-cart"
                [class.disabled]="!canAddToCart()"
                [disabled]="!canAddToCart()"
                (click)="addToCart()"
                [attr.aria-label]="'إضافة إلى السلة'">
                <i class="fas fa-shopping-bag"></i>
                <span class="btn-text">إضافة إلى السلة</span>
              </button>
              <button
                class="btn btn-wishlist"
                [class.active]="isFavorite"
                (click)="toggleWishlist()"
                [attr.aria-label]="isFavorite ? 'إزالة من المفضلة' : 'إضافة إلى المفضلة'">
                <i class="fas fa-heart"></i>
              </button>
            </div>

            <!-- Continue Shopping Button -->
            <div class="continue-shopping-wrapper">
              <button
                class="btn btn-continue-shopping"
                (click)="navigateToShop()"
                [attr.aria-label]="'استكمال التسوق'">
                <i class="fas fa-arrow-left"></i>
                <span class="btn-text">استكمال التسوق</span>
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Full Description Section -->
      <div *ngIf="product.description" class="row mt-5">
        <div class="col-12">
          <div class="full-description-section">
            <h2 class="section-title">تفاصيل المنتج</h2>
            <div class="description-content">
              <p>{{ product.description }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Related Products Section -->
      <div *ngIf="relatedProducts.length > 0" class="row mt-5">
        <div class="col-12">
          <div class="related-products-section">
            <h2 class="section-title">منتجات مشابهة</h2>
            <div class="related-products-grid">
              <div
                *ngFor="let relatedProduct of relatedProducts"
                class="related-product-card"
                (click)="navigateToProduct(relatedProduct._id)">
                <div class="related-product-image-wrapper">
                  <img
                    *ngIf="!hasImageError('related-' + relatedProduct._id)"
                    [src]="getImageUrl(relatedProduct.imageCover)"
                    [alt]="relatedProduct.title"
                    class="related-product-image"
                    (error)="onImageError('related-' + relatedProduct._id)"
                    loading="lazy">
                  <div *ngIf="hasImageError('related-' + relatedProduct._id) || !relatedProduct.imageCover"
                       class="related-product-image-placeholder">
                    <i class="fas fa-image fa-2x text-muted"></i>
                  </div>
                </div>
                <div class="related-product-info">
                  <h4 class="related-product-title">{{ relatedProduct.title }}</h4>
                  <div class="related-product-price">
                    <span class="current-price">
                      {{ (relatedProduct.priceAfterDiscount || relatedProduct.price) | currency:'EGP':'symbol':'1.0-0' }}
                    </span>
                    <span *ngIf="relatedProduct.priceAfterDiscount" class="original-price">
                      {{ relatedProduct.price | currency:'EGP':'symbol':'1.0-0' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
