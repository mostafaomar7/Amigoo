{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators, ReactiveFormsModule } from '@angular/forms';\nimport { FormsModule } from '@angular/forms';\nimport { CommonModule } from '@angular/common';\nimport { environment } from '../../../environments/environment';\nlet ProductsComponent = class ProductsComponent {\n  constructor(apiService, notificationService, fb) {\n    var _a;\n    this.apiService = apiService;\n    this.notificationService = notificationService;\n    this.fb = fb;\n    this.products = [];\n    this.categories = [];\n    this.masterSizes = [];\n    this.currentPage = 1;\n    this.itemsPerPage = 10;\n    this.totalItems = 0;\n    this.totalPages = 0;\n    this.searchTerm = '';\n    this.sortBy = 'createdAt';\n    this.sortOrder = 'desc';\n    this.isLoading = false;\n    this.showAddModal = false;\n    this.showEditModal = false;\n    this.showDeleteModal = false;\n    this.showDetailsModal = false;\n    this.showAddSizeModal = false;\n    this.selectedProduct = null;\n    this.selectedCoverImage = null;\n    this.selectedImages = [];\n    this.selectedEditCoverImage = null;\n    this.selectedEditImages = [];\n    this.productColors = [];\n    this.editProductColors = [];\n    this.newColor = '';\n    this.editNewColor = '';\n    this.productQuantity = [];\n    this.editProductQuantity = [];\n    this.selectedSizeToAdd = '';\n    this.selectedEditSizeToAdd = '';\n    this.currentImageIndex = 0;\n    this.uploadsBaseUrl = environment.apiUrl.replace('/api/v1', '') + '/uploads';\n    this.searchTimeout = null;\n    this.Math = Math;\n    this.productForm = this.createProductForm();\n    this.editProductForm = this.createProductForm();\n    this.sizeForm = this.fb.group({\n      sizeName: ['', [Validators.required, Validators.minLength(1), Validators.maxLength(10)]]\n    });\n    // Auto-lowercase size name\n    (_a = this.sizeForm.get('sizeName')) === null || _a === void 0 ? void 0 : _a.valueChanges.subscribe(value => {\n      var _a;\n      if (value) {\n        (_a = this.sizeForm.get('sizeName')) === null || _a === void 0 ? void 0 : _a.setValue(value.toLowerCase(), {\n          emitEvent: false\n        });\n      }\n    });\n  }\n  ngOnInit() {\n    this.loadProducts();\n    this.loadCategories();\n    this.loadMasterSizes();\n  }\n  ngOnDestroy() {\n    if (this.searchTimeout) {\n      clearTimeout(this.searchTimeout);\n    }\n  }\n  createProductForm() {\n    var _a, _b;\n    const form = this.fb.group({\n      title: ['', [Validators.required, Validators.minLength(3)]],\n      description: ['', [Validators.required, Validators.minLength(5)]],\n      price: ['', [Validators.required, Validators.min(0.01)]],\n      priceAfterDiscount: ['', [Validators.min(0)]],\n      category: ['', [Validators.required]]\n    });\n    // Add custom validator for discount price\n    (_a = form.get('priceAfterDiscount')) === null || _a === void 0 ? void 0 : _a.valueChanges.subscribe(() => {\n      this.validateDiscountPrice(form);\n    });\n    (_b = form.get('price')) === null || _b === void 0 ? void 0 : _b.valueChanges.subscribe(() => {\n      this.validateDiscountPrice(form);\n    });\n    return form;\n  }\n  validateDiscountPrice(form) {\n    var _a, _b, _c, _d, _e, _f;\n    const price = (_a = form.get('price')) === null || _a === void 0 ? void 0 : _a.value;\n    const discountPrice = (_b = form.get('priceAfterDiscount')) === null || _b === void 0 ? void 0 : _b.value;\n    if (discountPrice && price && discountPrice >= price) {\n      (_c = form.get('priceAfterDiscount')) === null || _c === void 0 ? void 0 : _c.setErrors({\n        discountGreaterThanPrice: true\n      });\n    } else if ((_d = form.get('priceAfterDiscount')) === null || _d === void 0 ? void 0 : _d.hasError('discountGreaterThanPrice')) {\n      const errors = Object.assign({}, (_e = form.get('priceAfterDiscount')) === null || _e === void 0 ? void 0 : _e.errors);\n      delete errors['discountGreaterThanPrice'];\n      (_f = form.get('priceAfterDiscount')) === null || _f === void 0 ? void 0 : _f.setErrors(Object.keys(errors).length > 0 ? errors : null);\n    }\n  }\n  loadProducts() {\n    this.isLoading = true;\n    const params = {\n      page: this.currentPage,\n      limit: this.itemsPerPage,\n      sort: `${this.sortOrder === 'desc' ? '-' : ''}${this.sortBy}`,\n      keyword: this.searchTerm || undefined\n    };\n    this.apiService.getPaginated('/product', params).subscribe({\n      next: response => {\n        this.products = response.data || [];\n        if (response.pagination) {\n          this.totalItems = response.pagination.totalItems || 0;\n          this.totalPages = response.pagination.totalPages || 0;\n          if (response.pagination.itemsPerPage) {\n            this.itemsPerPage = response.pagination.itemsPerPage;\n          }\n        } else {\n          const productsLength = this.products.length;\n          this.totalItems = productsLength;\n          this.totalPages = productsLength > 0 ? Math.max(1, Math.ceil(productsLength / this.itemsPerPage)) : 0;\n        }\n        this.isLoading = false;\n      },\n      error: error => {\n        console.error('Error loading products:', error);\n        this.isLoading = false;\n        this.totalPages = 0;\n        this.totalItems = 0;\n        this.notificationService.error('Error', 'Failed to load products');\n      }\n    });\n  }\n  loadCategories() {\n    this.apiService.getPaginated('/categories', {\n      limit: 100\n    }).subscribe({\n      next: response => {\n        this.categories = response.data || [];\n      },\n      error: error => {\n        console.error('Error loading categories:', error);\n      }\n    });\n  }\n  loadMasterSizes() {\n    this.apiService.getSingle('/sizes/master').subscribe({\n      next: response => {\n        this.masterSizes = response.data || response || [];\n      },\n      error: error => {\n        console.error('Error loading master sizes:', error);\n      }\n    });\n  }\n  loadProductDetails(productId) {\n    this.apiService.getById('/product', productId).subscribe({\n      next: response => {\n        this.selectedProduct = response.data;\n        this.showDetailsModal = true;\n        document.body.classList.add('modal-open');\n      },\n      error: error => {\n        console.error('Error loading product details:', error);\n        this.notificationService.error('Error', 'Failed to load product details');\n      }\n    });\n  }\n  onSearch() {\n    this.currentPage = 1;\n    this.loadProducts();\n  }\n  onSearchInput() {\n    if (this.searchTimeout) {\n      clearTimeout(this.searchTimeout);\n    }\n    this.searchTimeout = setTimeout(() => {\n      this.currentPage = 1;\n      this.loadProducts();\n    }, 500);\n  }\n  onSort(field) {\n    if (this.sortBy === field) {\n      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';\n    } else {\n      this.sortBy = field;\n      this.sortOrder = 'desc';\n    }\n    this.loadProducts();\n  }\n  goToPage(page) {\n    if (page >= 1 && page <= this.totalPages) {\n      this.currentPage = page;\n      this.loadProducts();\n    }\n  }\n  showAddProductModal() {\n    this.productForm.reset();\n    this.productColors = [];\n    this.productQuantity = [];\n    this.selectedCoverImage = null;\n    this.selectedImages = [];\n    this.selectedSizeToAdd = '';\n    this.showAddModal = true;\n    document.body.classList.add('modal-open');\n  }\n  showEditProductModal(product) {\n    this.selectedProduct = product;\n    this.editProductForm.patchValue({\n      title: product.title,\n      description: product.description,\n      price: product.price || '',\n      priceAfterDiscount: product.priceAfterDiscount || '',\n      category: product.category._id\n    });\n    this.editProductColors = product.colors ? [...product.colors] : [];\n    this.editProductQuantity = product.quantity ? JSON.parse(JSON.stringify(product.quantity)) : [];\n    this.selectedEditCoverImage = null;\n    this.selectedEditImages = [];\n    this.selectedEditSizeToAdd = '';\n    this.showEditModal = true;\n    document.body.classList.add('modal-open');\n  }\n  showEditFromDetails() {\n    if (this.selectedProduct) {\n      this.closeModals();\n      this.showEditProductModal(this.selectedProduct);\n    }\n  }\n  showDeleteProductModal(product) {\n    this.selectedProduct = product;\n    this.showDeleteModal = true;\n    document.body.classList.add('modal-open');\n  }\n  showDetailsProductModal(product) {\n    this.selectedProduct = product;\n    this.currentImageIndex = 0;\n    this.loadProductDetails(product._id);\n  }\n  addProduct() {\n    if (this.productForm.valid && this.selectedCoverImage) {\n      // Validate sizes exist in master sizes\n      if (this.productQuantity.length > 0) {\n        const invalidSizes = this.productQuantity.filter(qty => {\n          const sizeName = qty.size.toLowerCase().trim();\n          return !this.masterSizes.some(ms => ms.sizeName.toLowerCase() === sizeName);\n        });\n        if (invalidSizes.length > 0) {\n          this.notificationService.error('Validation Error', `The following sizes do not exist: ${invalidSizes.map(s => s.size.toUpperCase()).join(', ')}. Please create them first in Master Sizes.`);\n          return;\n        }\n      }\n      const formData = new FormData();\n      formData.append('title', this.productForm.value.title);\n      formData.append('description', this.productForm.value.description);\n      formData.append('price', this.productForm.value.price.toString());\n      if (this.productForm.value.priceAfterDiscount && this.productForm.value.priceAfterDiscount > 0) {\n        formData.append('priceAfterDiscount', this.productForm.value.priceAfterDiscount.toString());\n      }\n      formData.append('category', this.productForm.value.category);\n      formData.append('imageCover', this.selectedCoverImage);\n      this.productColors.forEach(color => formData.append('colors', color));\n      this.selectedImages.forEach(image => formData.append('images', image));\n      // Add quantity array - try both formats for compatibility\n      if (this.productQuantity.length > 0) {\n        // Ensure all sizes are lowercase and valid\n        const validQuantity = this.productQuantity.map(qty => ({\n          size: qty.size.toLowerCase().trim(),\n          no: Number(qty.no) || 0\n        })).filter(qty => qty.size && qty.no >= 0);\n        if (validQuantity.length > 0) {\n          // Send as JSON string (primary method per API docs)\n          formData.append('quantity', JSON.stringify(validQuantity));\n          // Also try sending as array format for some backends\n          validQuantity.forEach((qty, index) => {\n            formData.append(`quantity[${index}][size]`, qty.size);\n            formData.append(`quantity[${index}][no]`, qty.no.toString());\n          });\n        }\n      }\n      this.apiService.postFormData('/product', formData).subscribe({\n        next: response => {\n          this.notificationService.success('Success', 'Product added successfully');\n          this.closeModals();\n          this.loadProducts();\n        },\n        error: error => {\n          var _a, _b;\n          console.error('Error adding product:', error);\n          let errorMessage = 'Failed to add product';\n          if ((_a = error.error) === null || _a === void 0 ? void 0 : _a.message) {\n            errorMessage = error.error.message;\n          } else if (((_b = error.error) === null || _b === void 0 ? void 0 : _b.errors) && Array.isArray(error.error.errors)) {\n            errorMessage = error.error.errors.map(e => e.msg).join('. ');\n          }\n          this.notificationService.error('Error', errorMessage);\n        }\n      });\n    }\n  }\n  updateProduct() {\n    if (this.editProductForm.valid && this.selectedProduct) {\n      // Validate sizes exist in master sizes\n      if (this.editProductQuantity.length > 0) {\n        const invalidSizes = this.editProductQuantity.filter(qty => {\n          const sizeName = qty.size.toLowerCase().trim();\n          return !this.masterSizes.some(ms => ms.sizeName.toLowerCase() === sizeName);\n        });\n        if (invalidSizes.length > 0) {\n          this.notificationService.error('Validation Error', `The following sizes do not exist: ${invalidSizes.map(s => s.size.toUpperCase()).join(', ')}. Please create them first in Master Sizes.`);\n          return;\n        }\n      }\n      const formData = new FormData();\n      formData.append('title', this.editProductForm.value.title);\n      formData.append('description', this.editProductForm.value.description);\n      formData.append('price', this.editProductForm.value.price.toString());\n      if (this.editProductForm.value.priceAfterDiscount && this.editProductForm.value.priceAfterDiscount > 0) {\n        formData.append('priceAfterDiscount', this.editProductForm.value.priceAfterDiscount.toString());\n      }\n      formData.append('category', this.editProductForm.value.category);\n      if (this.selectedEditCoverImage) {\n        formData.append('imageCover', this.selectedEditCoverImage);\n      }\n      this.editProductColors.forEach(color => formData.append('colors', color));\n      this.selectedEditImages.forEach(image => formData.append('images', image));\n      // Add quantity array - try both formats for compatibility\n      if (this.editProductQuantity.length > 0) {\n        // Ensure all sizes are lowercase and valid\n        const validQuantity = this.editProductQuantity.map(qty => ({\n          size: qty.size.toLowerCase().trim(),\n          no: Number(qty.no) || 0\n        })).filter(qty => qty.size && qty.no >= 0);\n        if (validQuantity.length > 0) {\n          // Send as JSON string (primary method per API docs)\n          formData.append('quantity', JSON.stringify(validQuantity));\n          // Also try sending as array format for some backends\n          validQuantity.forEach((qty, index) => {\n            formData.append(`quantity[${index}][size]`, qty.size);\n            formData.append(`quantity[${index}][no]`, qty.no.toString());\n          });\n        }\n      }\n      this.apiService.putFormData('/product', this.selectedProduct._id, formData).subscribe({\n        next: response => {\n          this.notificationService.success('Success', 'Product updated successfully');\n          this.closeModals();\n          this.loadProducts();\n        },\n        error: error => {\n          var _a, _b;\n          console.error('Error updating product:', error);\n          let errorMessage = 'Failed to update product';\n          if ((_a = error.error) === null || _a === void 0 ? void 0 : _a.message) {\n            errorMessage = error.error.message;\n          } else if (((_b = error.error) === null || _b === void 0 ? void 0 : _b.errors) && Array.isArray(error.error.errors)) {\n            errorMessage = error.error.errors.map(e => e.msg).join('. ');\n          }\n          this.notificationService.error('Error', errorMessage);\n        }\n      });\n    }\n  }\n  deleteProduct() {\n    if (this.selectedProduct) {\n      this.apiService.delete('/product', this.selectedProduct._id).subscribe({\n        next: response => {\n          this.notificationService.success('Success', 'Product deleted successfully');\n          this.closeModals();\n          this.loadProducts();\n        },\n        error: error => {\n          var _a;\n          console.error('Error deleting product:', error);\n          this.notificationService.error('Error', ((_a = error.error) === null || _a === void 0 ? void 0 : _a.message) || 'Failed to delete product');\n        }\n      });\n    }\n  }\n  addSize() {\n    if (this.sizeForm.valid) {\n      const formData = {\n        sizeName: this.sizeForm.value.sizeName.toLowerCase()\n      };\n      this.apiService.post('/sizes', formData).subscribe({\n        next: response => {\n          this.notificationService.success('Success', 'Size added successfully');\n          this.closeModals();\n          this.loadMasterSizes();\n          // Reload product details if open\n          if (this.selectedProduct) {\n            this.loadProductDetails(this.selectedProduct._id);\n          }\n        },\n        error: error => {\n          var _a;\n          console.error('Error adding size:', error);\n          this.notificationService.error('Error', ((_a = error.error) === null || _a === void 0 ? void 0 : _a.message) || 'Failed to add size');\n        }\n      });\n    }\n  }\n  onCoverImageSelected(event, isEdit = false) {\n    const file = event.target.files[0];\n    if (file) {\n      if (isEdit) {\n        this.selectedEditCoverImage = file;\n      } else {\n        this.selectedCoverImage = file;\n      }\n    }\n  }\n  onImagesSelected(event, isEdit = false) {\n    const files = Array.from(event.target.files);\n    if (files.length > 0) {\n      // Limit to 5 images\n      const limitedFiles = files.slice(0, 5);\n      if (isEdit) {\n        this.selectedEditImages = limitedFiles;\n      } else {\n        this.selectedImages = limitedFiles;\n      }\n      if (files.length > 5) {\n        this.notificationService.error('Warning', 'Only the first 5 images will be used');\n      }\n    }\n  }\n  removeImage(index, isEdit = false) {\n    if (isEdit) {\n      this.selectedEditImages.splice(index, 1);\n    } else {\n      this.selectedImages.splice(index, 1);\n    }\n  }\n  addColor(isEdit = false) {\n    const color = isEdit ? this.editNewColor : this.newColor;\n    if (color) {\n      if (isEdit) {\n        if (!this.editProductColors.includes(color)) {\n          this.editProductColors.push(color);\n          this.editNewColor = '';\n        }\n      } else {\n        if (!this.productColors.includes(color)) {\n          this.productColors.push(color);\n          this.newColor = '';\n        }\n      }\n    }\n  }\n  removeColor(color, isEdit = false) {\n    if (isEdit) {\n      this.editProductColors = this.editProductColors.filter(c => c !== color);\n    } else {\n      this.productColors = this.productColors.filter(c => c !== color);\n    }\n  }\n  addSizeToQuantity(selectedSizeId = null, isEdit = false) {\n    const quantityArray = isEdit ? this.editProductQuantity : this.productQuantity;\n    let sizeToAdd;\n    if (selectedSizeId) {\n      // Add specific size\n      sizeToAdd = this.masterSizes.find(size => size._id === selectedSizeId);\n      if (sizeToAdd && quantityArray.some(q => q.size.toLowerCase() === sizeToAdd.sizeName.toLowerCase())) {\n        this.notificationService.error('Error', 'This size is already added');\n        return;\n      }\n    } else {\n      // Add first available size\n      sizeToAdd = this.masterSizes.find(size => !quantityArray.some(q => q.size.toLowerCase() === size.sizeName.toLowerCase()));\n    }\n    if (sizeToAdd) {\n      quantityArray.push({\n        size: sizeToAdd.sizeName,\n        no: 0\n      });\n    } else {\n      this.notificationService.error('Info', 'No available sizes to add');\n    }\n  }\n  getAvailableSizesForQuantity(isEdit = false) {\n    const quantityArray = isEdit ? this.editProductQuantity : this.productQuantity;\n    return this.masterSizes.filter(size => !quantityArray.some(q => q.size.toLowerCase() === size.sizeName.toLowerCase()));\n  }\n  removeSizeFromQuantity(index, isEdit = false) {\n    if (isEdit) {\n      this.editProductQuantity.splice(index, 1);\n    } else {\n      this.productQuantity.splice(index, 1);\n    }\n  }\n  updateQuantityValue(index, value, isEdit = false) {\n    const quantityArray = isEdit ? this.editProductQuantity : this.productQuantity;\n    if (quantityArray[index]) {\n      quantityArray[index].no = Math.max(0, value);\n    }\n  }\n  closeModals() {\n    this.showAddModal = false;\n    this.showEditModal = false;\n    this.showDeleteModal = false;\n    this.showDetailsModal = false;\n    this.showAddSizeModal = false;\n    this.selectedProduct = null;\n    this.currentImageIndex = 0;\n    document.body.classList.remove('modal-open');\n  }\n  showAddSizeFromDetailsModal() {\n    this.sizeForm.reset();\n    this.showAddSizeModal = true;\n    document.body.classList.add('modal-open');\n  }\n  nextImage() {\n    if (this.selectedProduct && this.selectedProduct.images && this.selectedProduct.images.length > 0) {\n      this.currentImageIndex = (this.currentImageIndex + 1) % (this.selectedProduct.images.length + 1);\n    }\n  }\n  prevImage() {\n    if (this.selectedProduct && this.selectedProduct.images && this.selectedProduct.images.length > 0) {\n      this.currentImageIndex = this.currentImageIndex === 0 ? this.selectedProduct.images.length : this.currentImageIndex - 1;\n    }\n  }\n  getImageUrl(imagePath) {\n    if (imagePath.startsWith('http')) {\n      return imagePath;\n    }\n    return `${this.uploadsBaseUrl}/products/${imagePath}`;\n  }\n  getImagePreview(file) {\n    if (file) {\n      return URL.createObjectURL(file);\n    }\n    return '';\n  }\n  getCurrentImage() {\n    if (!this.selectedProduct) return '';\n    if (this.currentImageIndex === 0) {\n      return this.getImageUrl(this.selectedProduct.imageCover);\n    }\n    if (this.selectedProduct.images && this.selectedProduct.images[this.currentImageIndex - 1]) {\n      return this.getImageUrl(this.selectedProduct.images[this.currentImageIndex - 1]);\n    }\n    return this.getImageUrl(this.selectedProduct.imageCover);\n  }\n  getSizeStatus(quantity) {\n    return quantity > 0 ? 'In Stock' : 'Out of Stock';\n  }\n  getSizeStatusClass(quantity) {\n    return quantity > 0 ? 'bg-success' : 'bg-danger';\n  }\n  get filteredProducts() {\n    return this.products;\n  }\n  get pageNumbers() {\n    if (!this.totalPages || this.totalPages <= 0) {\n      return [];\n    }\n    return Array.from({\n      length: this.totalPages\n    }, (_, i) => i + 1);\n  }\n  getFieldError(formGroup, fieldName) {\n    var _a, _b, _c, _d;\n    const control = formGroup.get(fieldName);\n    if (control && control.invalid && (control.dirty || control.touched)) {\n      if ((_a = control.errors) === null || _a === void 0 ? void 0 : _a['required']) {\n        return `${this.getFieldLabel(fieldName)} is required`;\n      }\n      if ((_b = control.errors) === null || _b === void 0 ? void 0 : _b['minlength']) {\n        const minLength = control.errors['minlength'].requiredLength;\n        return `${this.getFieldLabel(fieldName)} must be at least ${minLength} characters`;\n      }\n      if ((_c = control.errors) === null || _c === void 0 ? void 0 : _c['min']) {\n        const min = control.errors['min'].min;\n        return `${this.getFieldLabel(fieldName)} must be at least ${min}`;\n      }\n      if ((_d = control.errors) === null || _d === void 0 ? void 0 : _d['discountGreaterThanPrice']) {\n        return 'Discount price must be less than regular price';\n      }\n    }\n    return '';\n  }\n  hasFieldError(formGroup, fieldName) {\n    const control = formGroup.get(fieldName);\n    return !!(control && control.invalid && (control.dirty || control.touched));\n  }\n  getSelectedCategoryName(categoryId) {\n    const category = this.categories.find(c => c._id === categoryId);\n    return category ? category.name : '';\n  }\n  getFieldLabel(fieldName) {\n    const labels = {\n      title: 'Title',\n      description: 'Description',\n      price: 'Price',\n      priceAfterDiscount: 'Price After Discount',\n      category: 'Category',\n      sizeName: 'Size Name'\n    };\n    return labels[fieldName] || fieldName;\n  }\n};\nProductsComponent = __decorate([Component({\n  selector: 'app-products',\n  standalone: true,\n  imports: [CommonModule, FormsModule, ReactiveFormsModule],\n  templateUrl: './products.component.html',\n  styleUrls: ['./products.component.css']\n})], ProductsComponent);\nexport { ProductsComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}