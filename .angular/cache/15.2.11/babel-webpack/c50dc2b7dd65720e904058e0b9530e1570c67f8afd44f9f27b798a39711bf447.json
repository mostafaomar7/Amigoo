{"ast":null,"code":"import { HttpHeaders } from '@angular/common/http';\nimport { forkJoin, shareReplay } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { environment } from '../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport let DashboardService = /*#__PURE__*/(() => {\n  class DashboardService {\n    getHeaders() {\n      const token = localStorage.getItem('jwt');\n      const headers = {\n        'Content-Type': 'application/json'\n      };\n      if (token) {\n        headers['Authorization'] = `Bearer ${token}`;\n      }\n      return new HttpHeaders(headers);\n    }\n    constructor(http) {\n      this.http = http;\n      this.apiUrl = environment.apiUrl;\n    }\n    getDashboardStats() {\n      // Use getOrderStatistics to avoid duplicate API calls to /Order/stats\n      return forkJoin({\n        products: this.getProductsCount(),\n        orders: this.getOrderStatistics(),\n        messages: this.getUnreadMessagesCount()\n      }).pipe(map(data => ({\n        totalProducts: data.products,\n        totalOrders: data.orders.totalOrders,\n        pendingOrders: data.orders.pendingOrders,\n        totalRevenue: data.orders.totalRevenue,\n        unreadMessages: data.messages,\n        // Include full order statistics to avoid duplicate API calls\n        orderStatistics: data.orders\n      })));\n    }\n    getRecentActivity() {\n      return forkJoin({\n        recentOrders: this.getRecentOrders(),\n        recentProducts: this.getRecentProducts(),\n        recentMessages: this.getRecentMessages()\n      }).pipe(map(data => {\n        const activities = [];\n        data.recentOrders.forEach(order => {\n          activities.push({\n            id: order._id,\n            description: `New order #${order.orderNumber || order._id.slice(-6)} from ${order.fullName || 'Customer'}`,\n            timestamp: new Date(order.createdAt),\n            type: 'order'\n          });\n        });\n        data.recentProducts.forEach(product => {\n          activities.push({\n            id: product._id,\n            description: `Product \"${product.title}\" was added`,\n            timestamp: new Date(product.createdAt),\n            type: 'product'\n          });\n        });\n        data.recentMessages.forEach(message => {\n          activities.push({\n            id: message._id,\n            description: `New message from ${message.name}`,\n            timestamp: new Date(message.createdAt),\n            type: 'message'\n          });\n        });\n        return activities.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime()).slice(0, 10);\n      }));\n    }\n    getProductsCount() {\n      // Fetch products to get total count from results\n      return this.http.get(`${this.apiUrl}/product?limit=1`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => response.results || 0));\n    }\n    getOrdersStats() {\n      // Use the dedicated stats endpoint from API documentation\n      return this.http.get(`${this.apiUrl}/Order/stats`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => ({\n        total: response.totalOrders || 0,\n        pending: response.pendingOrders || 0,\n        revenue: response.totalRevenue || 0\n      })));\n    }\n    getUnreadMessagesCount() {\n      // Fetch all contact forms and count unread (isReplied: false)\n      return this.http.get(`${this.apiUrl}/submit`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => {\n        const data = response.data || [];\n        // Count messages where isReplied is false\n        return data.filter(msg => msg.isReplied === false).length;\n      }));\n    }\n    getRecentOrders() {\n      return this.http.get(`${this.apiUrl}/Order?limit=5&sort=-createdAt`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => response.data || []));\n    }\n    getRecentProducts() {\n      return this.http.get(`${this.apiUrl}/product?limit=5&sort=-createdAt`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => response.data || []));\n    }\n    getRecentMessages() {\n      return this.http.get(`${this.apiUrl}/submit?limit=5&sort=-createdAt`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => response.data || []));\n    }\n    getShippingInfo() {\n      return this.http.get(`${this.apiUrl}/settings/shipping/info`, {\n        headers: this.getHeaders()\n      });\n    }\n    calculateShipping(orderAmount) {\n      return this.http.post(`${this.apiUrl}/settings/shipping/calculate`, {\n        orderAmount\n      }, {\n        headers: this.getHeaders()\n      });\n    }\n    /**\n     * Get complete order statistics for admin dashboard\n     * Returns total, pending, completed, cancelled orders and total revenue\n     * Uses shareReplay to cache the result within the same execution context\n     * to avoid duplicate API calls when called multiple times\n     */\n    getOrderStatistics() {\n      return this.http.get(`${this.apiUrl}/Order/stats`, {\n        headers: this.getHeaders()\n      }).pipe(map(response => ({\n        totalOrders: response.totalOrders || 0,\n        pendingOrders: response.pendingOrders || 0,\n        completedOrders: response.completedOrders || 0,\n        cancelledOrders: response.cancelledOrders || 0,\n        totalRevenue: response.totalRevenue || 0\n      })), shareReplay({\n        bufferSize: 1,\n        refCount: true\n      }));\n    }\n  }\n  DashboardService.ɵfac = function DashboardService_Factory(t) {\n    return new (t || DashboardService)(i0.ɵɵinject(i1.HttpClient));\n  };\n  DashboardService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: DashboardService,\n    factory: DashboardService.ɵfac,\n    providedIn: 'root'\n  });\n  return DashboardService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}